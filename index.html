<script>
  // Smoke overlay
  (() => {
    const canvas = document.getElementById('smokeCanvas');
    const ctx = canvas.getContext('2d', { alpha: true });
    const img = new Image();
    img.src = 'Smoke.png';
    img.crossOrigin = 'anonymous';

    const layers = [
      { offset: 0, speed: 0.005, scale: 1.05, alpha: 0.95, horizSpeed: 2, turb: 10 },
      { offset: 0, speed: 0.003, scale: 1.3,  alpha: 0.9,  horizSpeed: -1, turb: 16 },
      { offset: 0, speed: 0.002, scale: 1.6,  alpha: 0.85, horizSpeed: 1, turb: 22 }
    ];

    let width = 0, height = 0, last = 0, tAccum = 0, playing = true;
    const DPR = Math.max(1, window.devicePixelRatio || 1);
    const cache = [];

    function resize() {
      width = window.innerWidth;
      height = window.innerHeight;
      canvas.width = Math.floor(width * DPR);
      canvas.height = Math.floor(height * DPR);
      canvas.style.width = width + 'px';
      canvas.style.height = height + 'px';
      ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
    }
    window.addEventListener('resize', resize);
    resize();

    function noise(seed) {
      return (Math.sin(seed * 12.9898) * 43758.5453) % 1;
    }

    img.onload = () => {
      layers.forEach((L, i) => {
        const cw = Math.ceil(img.width * L.scale);
        const ch = Math.ceil(img.height * L.scale);
        const c = document.createElement('canvas');
        c.width = cw * DPR;
        c.height = ch * DPR;
        const cc = c.getContext('2d');
        cc.setTransform(DPR, 0, 0, DPR, 0, 0);
        cc.drawImage(img, 0, 0, cw, ch);
        cache[i] = c;
        L.offset = (i * ch / 2) % ch;
      });
    };

    function clear() {
      ctx.clearRect(0, 0, width, height);
    }

    function drawLayer(layer, dt, tAccum, cacheCanvas) {
      const layerW = cacheCanvas.width / DPR;
      const layerH = cacheCanvas.height / DPR;
      layer.offset = (layer.offset - layer.speed * height * (dt / 1000)) % layerH;
      const baseX = Math.sin((tAccum / 1000) * (layer.horizSpeed / 3)) * (layer.horizSpeed * 6);
      const turbX = (noise(tAccum * 0.001 + layer.scale) - 0.5) * layer.turb;
      const drawX = (width / 2) - layerW / 2 + baseX + turbX;

      ctx.globalAlpha = layer.alpha;
      ctx.globalCompositeOperation = 'screen';
      for (let y = -layerH + layer.offset; y < height + layerH; y += layerH) {
        ctx.drawImage(cacheCanvas, drawX, y, layerW, layerH);
      }
      ctx.globalAlpha = 1;
      ctx.globalCompositeOperation = 'source-over';
    }

    function bloomPass() {
      ctx.save();
      ctx.globalCompositeOperation = 'lighter';
      ctx.globalAlpha = 0.055;
      ctx.fillStyle = 'rgba(220,40,60,1)';
      ctx.fillRect(0, 0, width, height);
      ctx.restore();
    }

    function animate(now) {
      if (!last) last = now;
      const dt = now - last || 16;
      last = now;
      tAccum += dt;
      if (playing) {
        clear();
        for (let i = 0; i < layers.length; ++i) {
          if (cache[i]) drawLayer(layers[i], dt, tAccum, cache[i]);
        }
        bloomPass();
      }
      requestAnimationFrame(animate);
    }
    requestAnimationFrame(animate);

    window.addEventListener('keydown', (e) => {
      if (e.key === 's' || e.key === 'S') {
        playing = !playing;
        canvas.style.display = playing ? 'block' : 'none';
      }
    });
  })();

  // Menu toggle
  (() => {
    const btn = document.getElementById('menuBtn');
    const sidebar = document.getElementById('sidebar');
    if (btn && sidebar) {
      btn.addEventListener('click', () => {
        const open = sidebar.classList.toggle('open');
        sidebar.setAttribute('aria-hidden', !open);
        btn.setAttribute('aria-expanded', open);
      });
      document.addEventListener('click', (e) => {
        const inside = e.target.closest('#sidebar') || e.target.closest('#menuBtn');
        if (!inside && sidebar.classList.contains('open')) sidebar.classList.remove('open');
      });
    }
  })();
</script>
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Aggro PvP — Loop twice then red surge with JOIN</title>
<style>
  /* === Config === */
  :root{
    --loops-before-glitch:2;     /* how many smoke loops before the surge */
    --surge-ms:2000;             /* how long the surge (red + join + blood) remains */
    --glitch-ms:480;             /* micro-glitch within the surge */
    --smoke-opacity:0.56;        /* smoke visibility so UI under it reads */
    --red-strength:0.32;
    --splat-opacity:0.9;
  }

  /* === Font (your custom menu font) ===
     Place Aggro-font.woff2 in repo root. Fallback to system stack if missing.
  */
  @font-face{
    font-family: "AggroUI";
    src: url("Aggro-font.woff2") format("woff2");
    font-weight: 400 800;
    font-style: normal;
    font-display: swap;
  }

  html,body{height:100%;margin:0;background:#050505;color:#fff;font-family:AggroUI,Inter,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;overflow:hidden;-webkit-font-smoothing:antialiased}
  img{display:block;max-width:100%}
  button{background:transparent;border:0;cursor:pointer;color:inherit;font:inherit}

  /* z-index plan:
     6000 menu (always clickable)
     4000 headline + blood (pops under smoke so smoke overlays)
     3500 glitch paint (red wash + RGB slices) composited above headline but under smoke
     3000 smoke video (top visual overlay)
     1000 UI (logo/buttons) visually under smoke but still visible due to opacity
  */

  /* Menu (uses AggroUI font) */
  .anarchyBtn{position:fixed;top:18px;right:18px;z-index:6000;padding:6px}
  .anarchyBtn img{width:56px;height:56px;display:block}
  .anarchyMenu{position:fixed;top:86px;right:18px;z-index:6000;display:none;flex-direction:column;gap:8px;padding:10px;background:rgba(6,6,6,0.98);border-radius:10px;box-shadow:0 14px 40px rgba(0,0,0,0.6)}
  .anarchyMenu.open{display:flex}
  .anarchyMenu a{font-family:AggroUI,inherit;font-weight:700;color:#fff;text-decoration:none;padding:8px 12px;border-radius:6px;font-size:15px;letter-spacing:0.6px}

  /* Headline (JOIN image) and blood sit under the smoke so smoke overlays them */
  .headlineWrap{position:fixed;inset:0;z-index:4000;display:flex;align-items:center;justify-content:center;pointer-events:none}
  .joinImg{width:74vw;max-width:920px;opacity:0;transform:translateY(28px) scale(.98);transition:opacity 180ms ease,transform 260ms cubic-bezier(.2,.9,.3,1);filter:drop-shadow(0 22px 36px rgba(0,0,0,0.9))}
  .joinImg.show{opacity:1;transform:translateY(0) scale(1.02)}
  /* fallback text if join.png missing */
  .joinText{display:none;font-size:clamp(28px,9vw,96px);font-weight:900;letter-spacing:6px;text-align:center;-webkit-text-stroke:1.6px rgba(0,0,0,0.95);text-shadow:0 10px 28px rgba(0,0,0,0.9)}
  .joinText.show{display:block}

  /* blood splats under smoke (they will be visible through semi-transparent smoke) */
  .splat{position:fixed;pointer-events:none;mix-blend-mode:multiply;opacity:0;transition:opacity 200ms linear,transform 360ms cubic-bezier(.2,.9,.3,1)}
  .splat.left{top:4%;left:3.5%;width:420px;transform:translateY(18px) rotate(-18deg) scale(.9);z-index:4000}
  .splat.right{bottom:4%;right:3.5%;width:380px;transform:translateY(18px) rotate(12deg) scale(.9);z-index:4000}
  .splat.show{opacity:var(--splat-opacity);transform:translateY(0) scale(1)}

  /* Glitch paint (red wash + optional RGB slices). It's shown briefly but sits under the smoke element so smoke remains topmost. */
  .glitch-paint{position:fixed;inset:0;z-index:3500;pointer-events:none;opacity:0;transition:opacity 120ms linear}
  .glitch-paint.show{opacity:1}
  .red-wash{position:absolute;inset:0;background:rgba(255,18,18,var(--red-strength));mix-blend-mode:overlay;pointer-events:none;opacity:1}

  /* Smoke (top visual overlay) */
  #smoke-wrap{position:fixed;inset:0;z-index:3000;pointer-events:none}
  #smokeVideo{width:100%;height:100%;object-fit:cover;opacity:var(--smoke-opacity);filter:blur(1.6px) saturate(1) contrast(1);transform-origin:center center;will-change:transform,filter,opacity}
  #smokeVideo.glitch{transition:transform var(--glitch-ms) cubic-bezier(.22,.9,.3,1),filter var(--glitch-ms) linear,opacity var(--glitch-ms) linear;transform:translateY(-6px) scale(1.02);filter:blur(3px) contrast(1.06) saturate(1.12);opacity:0.96;}

  /* UI under smoke */
  #logo{position:fixed;top:9vh;left:50%;transform:translateX(-50%);z-index:1000}
  .widget-bar{position:fixed;left:50%;transform:translateX(-50%);bottom:36px;z-index:1000;display:flex;flex-direction:column;gap:12px;align-items:center}
  .cta{padding:12px 20px;border-radius:10px;color:#fff;text-decoration:none;font-weight:800;background:rgba(0,0,0,0.45)}
  .primary{background:rgba(255,40,40,0.95)}.secondary{background:#5865F2}

  @media(max-width:520px){
    .joinImg{width:86vw}
    .splat.left{width:320px;top:2%}
    .splat.right{width:300px;right:2%;bottom:2%}
    .anarchyBtn img{width:48px;height:48px}
  }
</style>
</head>
<body>

  <!-- Menu -->
  <button id="anarchyBtn" class="anarchyBtn" aria-expanded="false" aria-controls="anarchyMenu" title="Menu">
    <img src="anarchy.png" alt="Menu">
  </button>
  <nav id="anarchyMenu" class="anarchyMenu" aria-hidden="true" role="navigation">
    <a href="rules.html">Rules</a>
    <a href="support.html">Support</a>
    <a href="donate.html">Donate</a>
    <a href="killfeed.html">Kill Feed</a>
    <a href="leaderboard.html">Leaderboard</a>
  </nav>

  <!-- Headline (image in your font) — appears under the smoke -->
  <div class="headlineWrap" aria-hidden="true">
    <img id="joinImg" class="joinImg" src="join.png" alt="JOIN THE FIGHT (art)" onerror="this.style.display='none';document.getElementById('joinText').classList.add('show')">
    <div id="joinText" class="joinText" aria-hidden="true">JOIN THE FIGHT</div>
  </div>

  <!-- Blood splats (under smoke) -->
  <img id="splatLeft" class="splat left" src="blood.png" alt="blood left" />
  <img id="splatRight" class="splat right" src="blood1.png" alt="blood right" />

  <!-- Glitch paint (red wash shown during surge) -->
  <div id="glitchPaint" class="glitch-paint" aria-hidden="true">
    <div class="red-wash"></div>
  </div>

  <!-- Smoke video (top overlay) -->
  <div id="smoke-wrap" aria-hidden="true">
    <video id="smokeVideo" muted playsinline preload="auto" crossorigin="anonymous">
      <source src="Smoke.mp4?v=1" type="video/mp4">
    </video>
  </div>

  <!-- UI under smoke -->
  <div id="logo"><img src="Aggro-logo.PNG" alt="Aggro PvP Logo"></div>
  <div class="widget-bar">
    <a class="cta primary" href="steam://connect/103.193.80.64:3436">Connect to Server</a>
    <a class="cta secondary" href="https://discord.gg/gSwkVzJyMT" target="_blank" rel="noopener">Join the Community</a>
  </div>

<script>
(function(){
  const smoke = document.getElementById('smokeVideo');
  const joinImg = document.getElementById('joinImg');
  const joinText = document.getElementById('joinText');
  const splatL = document.getElementById('splatLeft');
  const splatR = document.getElementById('splatRight');
  const glitchPaint = document.getElementById('glitchPaint');

  const LOOPS_BEFORE_GLITCH = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--loops-before-glitch')) || 2;
  const SURGE_MS = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--surge-ms')) || 2000;
  const GLITCH_MS = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--glitch-ms')) || 480;

  let prevTime = 0;
  let loopCounter = 0;
  let surgeLock = false;

  // Ensure video keeps playing forever
  smoke.loop = true;

  // Start playback; if autoplay blocked we'll resume on first click
  smoke.play().catch(()=>{});

  // Utility show / hide
  function showSurgeVisuals(){
    // Show the JOIN (image if available, else text) and splats and red wash
    if (joinImg && !joinImg.complete) {
      // if image still loading, wait a tick before showing
      joinImg.onload = () => joinImg.classList.add('show');
    } else if (joinImg && joinImg.style.display !== 'none') {
      joinImg.classList.add('show');
    } else {
      joinText.classList.add('show');
    }
    splatL.classList.add('show');
    splatR.classList.add('show');
    glitchPaint.classList.add('show');
  }
  function hideSurgeVisuals(){
    if (joinImg) joinImg.classList.remove('show');
    joinText.classList.remove('show');
    splatL.classList.remove('show');
    splatR.classList.remove('show');
    glitchPaint.classList.remove('show');
  }

  // Core surge routine (non-destructive — smoke keeps playing on top)
  async function runSurge(){
    if (surgeLock) return;
    surgeLock = true;

    // small micro-transform on video to add punch (non-blocking)
    smoke.classList.add('glitch');

    showSurgeVisuals();

    // micro-glitch hold
    await new Promise(r => setTimeout(r, GLITCH_MS));

    // settle micro-transform quickly
    smoke.classList.remove('glitch');

    // keep the red + join + blood visible for remainder of SURGE_MS
    await new Promise(r => setTimeout(r, Math.max(0, SURGE_MS - GLITCH_MS)));

    hideSurgeVisuals();

    // short cooldown
    setTimeout(()=> surgeLock = false, 220);
  }

  // Loop counter by detecting time wrap (reliable for short clips)
  smoke.addEventListener('timeupdate', ()=>{
    const t = smoke.currentTime || 0;
    // detect wrap: previous time larger than current by >0.25s indicates loop happened
    if (prevTime - t > 0.25){
      loopCounter++;
      if (loopCounter >= LOOPS_BEFORE_GLITCH){
        loopCounter = 0;
        // Run surge but ensure the video is playing (if it stalled)
        smoke.play().catch(()=>{});
        runSurge().catch(()=>{ surgeLock = false; });
      }
    }
    prevTime = t;
  });

  // Menu logic (uses AggroUI font if available)
  const anarchyBtn = document.getElementById('anarchyBtn');
  const anarchyMenu = document.getElementById('anarchyMenu');
  function openMenu(open){
    if(open){
      anarchyMenu.classList.add('open');
      anarchyMenu.setAttribute('aria-hidden','false');
      anarchyBtn.setAttribute('aria-expanded','true');
      const f = anarchyMenu.querySelector('a'); if(f) f.focus();
    } else {
      anarchyMenu.classList.remove('open');
      anarchyMenu.setAttribute('aria-hidden','true');
      anarchyBtn.setAttribute('aria-expanded','false');
    }
  }
  anarchyBtn.addEventListener('click', e=>{ e.stopPropagation(); openMenu(!anarchyMenu.classList.contains('open')); });
  document.addEventListener('click', e=>{ if(!e.target.closest('.anarchyBtn') && !e.target.closest('.anarchyMenu')) openMenu(false); });
  document.addEventListener('keydown', e=>{ if(e.key === 'Escape') openMenu(false); });

  // Resume playback on first user interaction if autoplay blocked
  document.addEventListener('click', ()=>{ if(smoke.paused) smoke.play().catch(()=>{}); });

  // Safety start
  (async function init(){
    try { smoke.currentTime = 0; await smoke.play(); } catch(e){}
  })();

})();
</script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Aggro PvP — Looping Smoke + Flip Interstitial (fixed)</title>
<style>
  :root{
    --surge-ms:2200;        /* how long headline stays during interstitial */
    --flip-ms:560;          /* duration of visual flip */
    --smoke-opacity:0.48;   /* make smoke see-through */
    --red-strength:0.26;    /* red wash during glitch */
    --splat-opacity:0.72;
  }

  /* Core resets */
  html,body{height:100%;margin:0;background:#000;color:#fff;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;overflow:hidden}
  img{display:block;max-width:100%}

  /* Z-order summary
     4000 = anarchy menu (always top/interactive)
     3000 = headline + splats (must be readable during interstitial)
     2200 = flip overlay (plays once, sits above main smoke)
     2000 = main smoke (looping background)
     1000 = logo / CTAs (under smoke)
  */

  /* Menu (always clickable above smoke) */
  .anarchyBtn{position:fixed;top:18px;right:18px;z-index:4000;background:transparent;border:0;padding:6px;cursor:pointer}
  .anarchyBtn img{width:56px;height:56px;display:block}
  .anarchyMenu{position:fixed;top:86px;right:18px;z-index:4000;display:none;flex-direction:column;gap:8px;padding:10px;background:rgba(10,10,10,0.98);border-radius:10px;box-shadow:0 12px 40px rgba(0,0,0,0.6)}
  .anarchyMenu.open{display:flex}
  .anarchyMenu a{color:#fff;text-decoration:none;padding:8px 10px;border-radius:6px;font-weight:700;font-size:14px}

  /* Headline (visible during interstitial) */
  .headline{position:fixed;inset:0;z-index:3000;display:flex;align-items:center;justify-content:center;pointer-events:none;padding:6vh 4vw}
  #headlineText{margin:0;color:#fff;font-weight:900;letter-spacing:6px;text-align:center;-webkit-text-stroke:2px rgba(0,0,0,0.95);text-shadow:0 6px 18px rgba(0,0,0,0.9);font-size:clamp(28px,9.2vw,96px);opacity:0;will-change:opacity,transform}
  .show-headline #headlineText{animation:pop var(--surge-ms) cubic-bezier(.2,.9,.3,1) forwards}
  @keyframes pop{0%{opacity:0;transform:translateY(22px) scale(.98)}12%{opacity:1;transform:translateY(0) scale(1.05)}85%{opacity:1}100%{opacity:0;transform:translateY(-16px) scale(.98)}}

  /* Main smoke (single looping video) */
  #main-smoke{position:fixed;inset:0;z-index:2000;pointer-events:none}
  #mainVideo{width:100%;height:100%;object-fit:cover;opacity:var(--smoke-opacity);filter:blur(2px) saturate(1) contrast(1);animation:smokeBob 8s ease-in-out infinite}
  @keyframes smokeBob{0%{transform:translateY(0)}25%{transform:translateY(-6px)}50%{transform:translateY(0)}75%{transform:translateY(6px)}100%{transform:translateY(0)}}

  /* Flip overlay: cloned video plays here, slides from top a little for impact */
  #flip-overlay{position:fixed;left:0;right:0;top:-100vh;height:100vh;z-index:2200;pointer-events:none;display:flex;align-items:flex-start;justify-content:center;overflow:hidden;transition:top 420ms cubic-bezier(.2,.9,.3,1)}
  #flip-overlay.active{top:0}
  #flipVideo{width:100%;height:100%;object-fit:cover;transform-origin:center center;filter:blur(3px) saturate(1.05) contrast(1.02)}

  /* Red wash + glitch sheen over flip */
  #redWash{position:fixed;inset:0;z-index:2250;pointer-events:none;background:rgba(255,24,24,var(--red-strength));mix-blend-mode:overlay;opacity:0;transition:opacity 120ms linear}
  #redWash.show{opacity:1}

  /* Splats / blood shown above flip */
  #surge{position:fixed;inset:0;z-index:3000;display:flex;align-items:center;justify-content:center;pointer-events:none;opacity:0;transition:opacity 120ms linear}
  #surge.show{opacity:1}
  .splat{position:absolute;pointer-events:none;mix-blend-mode:multiply;opacity:var(--splat-opacity)}
  .splat.left{top:8%;left:4%;width:420px;transform:rotate(-18deg)}
  .splat.right{bottom:8%;right:6%;width:420px;transform:rotate(10deg)}
  .splat img{display:block;width:100%;height:auto;filter:contrast(1.12) saturate(1.08)}
  .splat.flash{animation:flash 420ms ease-out both}
  @keyframes flash{0%{filter:brightness(1)}40%{filter:brightness(1.35)}100%{filter:brightness(1)}}

  /* Logo/buttons under smoke */
  #logo{position:fixed;top:9vh;left:50%;transform:translateX(-50%);z-index:1000}
  .widget-bar{position:fixed;left:50%;transform:translateX(-50%);bottom:36px;z-index:1000;display:flex;flex-direction:column;gap:12px;align-items:center}
  .cta{padding:12px 24px;border-radius:10px;color:#fff;text-decoration:none;font-weight:800;background:rgba(0,0,0,0.45)}
  .primary{background:rgba(255,40,40,0.95)}.secondary{background:#5865F2}

  @media(max-width:520px){
    #headlineText{font-size:clamp(20px,12vw,64px)}
    .splat.left{width:320px;top:6%}
    .splat.right{width:280px;right:4%;bottom:6%}
    .anarchyBtn img{width:48px;height:48px}
  }
</style>
</head>
<body>

  <!-- Menu (always top) -->
  <button id="anarchyBtn" class="anarchyBtn" aria-expanded="false" aria-controls="anarchyMenu" title="Menu"><img src="anarchy.png" alt="Menu"></button>
  <nav id="anarchyMenu" class="anarchyMenu" aria-hidden="true" role="navigation">
    <a href="rules.html">Rules</a><a href="support.html">Support</a><a href="donate.html">Donate</a><a href="killfeed.html">Kill Feed</a><a href="leaderboard.html">Leaderboard</a>
  </nav>

  <!-- Headline (visible during interstitial) -->
  <div class="headline" id="headlineWrap" aria-hidden="true"><h1 id="headlineText">JOIN THE FIGHT</h1></div>

  <!-- Splats -->
  <div id="surge" aria-hidden="true">
    <div class="splat left" id="splatLeft"><img src="blood.png" alt=""></div>
    <div class="splat right" id="splatRight"><img src="blood1.png" alt=""></div>
  </div>

  <!-- Flip overlay (plays cloned video upside-down briefly) -->
  <div id="flip-overlay" aria-hidden="true">
    <video id="flipVideo" playsinline muted crossorigin="anonymous"></video>
  </div>
  <div id="redWash" aria-hidden="true"></div>

  <!-- Main looping smoke -->
  <div id="main-smoke" aria-hidden="true">
    <video id="mainVideo" autoplay muted playsinline loop preload="auto" crossorigin="anonymous">
      <source src="Smoke.mp4?v=1" type="video/mp4">
    </video>
  </div>

  <!-- Logo + CTAs (under smoke) -->
  <div id="logo"><img src="Aggro-logo.PNG" alt="Aggro PvP Logo"></div>
  <div class="widget-bar"><a class="cta primary" href="steam://connect/103.193.80.64:3436">Connect to Server</a><a class="cta secondary" href="https://discord.gg/gSwkVzJyMT" target="_blank" rel="noopener">Join the Community</a></div>

<script>
(function(){
  const mainVideo = document.getElementById('mainVideo');
  const flipVideo = document.getElementById('flipVideo');
  const flipOverlay = document.getElementById('flip-overlay');
  const redWash = document.getElementById('redWash');

  const headlineWrap = document.getElementById('headlineWrap');
  const surge = document.getElementById('surge');
  const splatL = document.getElementById('splatLeft');
  const splatR = document.getElementById('splatRight');

  const anarchyBtn = document.getElementById('anarchyBtn');
  const anarchyMenu = document.getElementById('anarchyMenu');

  const SURGE_MS = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--surge-ms')) || 2200;
  const FLIP_MS = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--flip-ms')) || 560;
  const TRIGGER_BEFORE_END = 0.28; // seconds before end to trigger flip interstitial

  // Keep main looping
  mainVideo.loop = true;

  // ensure single main video node
  (function removeDupes(){ const v = document.querySelectorAll('video#mainVideo'); if(v.length>1) v.forEach((el,i)=>{ if(i>0) el.remove(); }); })();

  // preload flip video source as same file (no weird upside-down footage). You can replace flipSrc if you have a separate baked clip
  const flipSrc = mainVideo.querySelector('source').src; // default to same file
  function prepareFlipVideo(){
    while(flipVideo.firstChild) flipVideo.removeChild(flipVideo.firstChild);
    const s = document.createElement('source'); s.src = flipSrc; s.type = 'video/mp4';
    flipVideo.appendChild(s);
    flipVideo.load();
  }
  prepareFlipVideo();

  // helpers to show/hide visuals
  function showHeadlineAndSplats(){
    headlineWrap.classList.add('show-headline'); headlineWrap.setAttribute('aria-hidden','false');
    surge.classList.add('show'); surge.setAttribute('aria-hidden','false');
    splatL.classList.add('flash'); splatR.classList.add('flash');
    setTimeout(()=>{ splatL.classList.remove('flash'); splatR.classList.remove('flash'); }, 480);
  }
  function hideHeadlineAndSplats(){
    headlineWrap.classList.remove('show-headline'); headlineWrap.setAttribute('aria-hidden','true');
    surge.classList.remove('show'); surge.setAttribute('aria-hidden','true');
  }

  // run flip: clone visual by using flipVideo, play once upside-down, then hide and resume main loop from start
  let running = false;
  async function runFlipOnce(){
    if(running) return;
    running = true;
    // pause main so background is static during flip
    try { mainVideo.pause(); } catch(e){}

    // ensure flipVideo is ready and reset
    flipVideo.pause(); flipVideo.currentTime = 0;
    flipVideo.style.transform = 'scaleY(-1) rotate(180deg)'; // visually upside-down
    flipOverlay.classList.add('active');
    redWash.classList.add('show');

    // small delay so overlay slide looks natural
    await new Promise(r=>setTimeout(r, 80));

    // attempt to play flipVideo
    try { await flipVideo.play(); } catch(e){ /* autoplay blocked — still show visuals */ }

    // show headline and splats while flipped clip plays
    showHeadlineAndSplats();

    // wait for it to finish (or fallback)
    const ended = new Promise(r=>{
      const onEnd = ()=>{ flipVideo.removeEventListener('ended', onEnd); r(); };
      flipVideo.addEventListener('ended', onEnd);
    });
    const fallback = new Promise(r=>setTimeout(r, (flipVideo.duration && !isNaN(flipVideo.duration) ? (flipVideo.duration*1000) : 1400) + 600));
    await Promise.race([ended, fallback]);

    // hide visuals
    hideHeadlineAndSplats();
    redWash.classList.remove('show');

    // slide overlay away and reset flipVideo
    flipOverlay.classList.remove('active');
    try { flipVideo.pause(); flipVideo.currentTime = 0; } catch(e){}

    // restart mainVideo from 0 and resume loop
    try { mainVideo.currentTime = 0; await mainVideo.play(); } catch(e){ /* autoplay blocked */ }

    // small buffer before allowing next run
    setTimeout(()=>{ running = false; }, 220);
  }

  // Trigger the flip when main is near its end
  function onMainTime(){
    if(running) return;
    if(!mainVideo.duration || isNaN(mainVideo.duration)) return;
    const remaining = mainVideo.duration - mainVideo.currentTime;
    if(remaining <= TRIGGER_BEFORE_END){
      runFlipOnce().catch(()=>{ running = false; });
    }
  }
  mainVideo.addEventListener('timeupdate', onMainTime);

  // Expose manual trigger for quick testing in console
  window.triggerFlip = ()=>{ runFlipOnce().catch(()=>{ running = false; }); };

  // menu toggle logic
  function openMenu(open){
    if(open){ anarchyMenu.classList.add('open'); anarchyMenu.setAttribute('aria-hidden','false'); anarchyBtn.setAttribute('aria-expanded','true'); const f = anarchyMenu.querySelector('a'); if(f) f.focus(); }
    else { anarchyMenu.classList.remove('open'); anarchyMenu.setAttribute('aria-hidden','true'); anarchyBtn.setAttribute('aria-expanded','false'); }
  }
  anarchyBtn.addEventListener('click', e=>{ e.stopPropagation(); openMenu(!anarchyMenu.classList.contains('open')); });
  document.addEventListener('click', e=>{ if(!e.target.closest('.anarchyBtn') && !e.target.closest('.anarchyMenu')) openMenu(false); });
  document.addEventListener('keydown', e=>{ if(e.key === 'Escape') openMenu(false); });

  // try to unlock autoplay on first interaction
  document.addEventListener('click', ()=>{ if(mainVideo.paused && !running) mainVideo.play().catch(()=>{}); });

  // start main loop
  mainVideo.play().catch(()=>{});
})();
</script>
</body>
</html>
